---

- hosts: localhost
  connection: local
  gather_facts: false
  vars:
      inst_name: "adianaopsgadget"
      keypair: "adiana"
      instance_type: "t1.micro"
      image: "ami-86e0ffe7"
      group: "sg-94d221f2"
      region: "us-west-2"
  tasks:
    - name: make one instance
      ec2: image={{ image }}
           instance_type={{ instance_type }}
           keypair={{ keypair }}
           instance_tags='{"Name":"{{ inst_name }}"}'
           region={{ region }}
           group_id={{ group }}
           wait=true
      register: ec2_info

    - name: Add instances to host group
      add_host: hostname={{ item.public_ip }} groupname=ec2hosts
      with_items: "{{ ec2_info.instances }}"

    - name: Wait for SSH to come up
      wait_for: host={{ item.public_dns_name }} port=22 delay=60 timeout=320 state=started
      with_items: "{{ ec2_info.instances }}"

    - name: Add easily greppable ip address to output
      debug: msg="{{ item.public_ip }}"
      with_items: "{{ ec2_info.instances }}"
